stages:
  - test

variables:
  POSTGRES_DB: healenium
  POSTGRES_USER: healenium_user
  POSTGRES_PASSWORD: YDk2nmNs4s9aCP6K
  SPRING_POSTGRES_DB_HOST: postgres-db
  HLM_LOG_LEVEL: info

services:
  - name: docker:dind
    alias: docker

healenium-tests:
  stage: test
  image: maven:3.8.6-openjdk-11
  services:
    - name: docker:20.10.16-dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  tags:
    - dind
  before_script:
    - apt-get update
    - apt-get install -y docker-compose chromium chromium-driver
    - export CHROME_BIN=/usr/bin/chromium-browser
    - export CHROMEDRIVER_PATH=/usr/bin/chromedriver
  script:
    # Start Healenium services
    - cd infra
    - docker-compose up -d
    - sleep 10 # Wait for services to initialize
    - cd ..
    # Run tests
    - mvn clean test

    # Stop services
    - cd infra
    - docker-compose down
  artifacts:
    when: always
    paths:
      - target/surefire-reports/
      - healing.json
    expire_in: 1 week
