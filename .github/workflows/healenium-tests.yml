name: Healenium Tests

on: [push, workflow_dispatch]

env:
  POSTGRES_DB: healenium
  POSTGRES_USER: healenium_user
  POSTGRES_PASSWORD: YDk2nmNs4s9aCP6K
  SPRING_POSTGRES_DB_HOST: postgres-db
  HLM_LOG_LEVEL: info

jobs:
  healenium-tests:
    runs-on: ubuntu-latest
    services:
      postgres-db:
        image: postgres:13
        env:
          POSTGRES_DB: healenium
          POSTGRES_USER: healenium_user
          POSTGRES_PASSWORD: YDk2nmNs4s9aCP6K
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Set up Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose chromium-driver postgresql-client
          export CHROME_BIN=/usr/bin/chromium-browser
          export CHROMEDRIVER_PATH=/usr/bin/chromedriver

      - name: Cache database backup
        uses: actions/cache@v3
        id: db-cache
        with:
          path: db_dump/backup.sql
          key: db-backup-${{ github.ref }}

      - name: Start Healenium services
        run: |
          cd infra
          docker-compose up -d
          cd ..

      - name: Wait for services
        run: sleep 15

      - name: Restore database from backup
        run: |
          mkdir -p db_dump
          if [ -f db_dump/backup.sql ]; then
            echo "üóÉÔ∏è Restoring database from backup.sql..."
            psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} < db_dump/backup.sql
          else
            echo "üöÄ First run - no backup found. Starting fresh."
          fi

      - name: Initialize database schema
        run: |
          echo "üîß Setting up schema and counter table..."
          psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "CREATE SCHEMA IF NOT EXISTS healenium AUTHORIZATION ${{ env.POSTGRES_USER }};"
          psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "CREATE TABLE IF NOT EXISTS healenium.run_counter (run_id SERIAL PRIMARY KEY, run_time TIMESTAMP DEFAULT now());"
          psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "INSERT INTO healenium.run_counter DEFAULT VALUES;"

      - name: Show run counter
        run: |
          echo "üü¢ Total number of pipeline runs so far:"
          psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "SELECT COUNT(*) AS total_runs FROM healenium.run_counter;"
          echo "üïí Last 5 pipeline runs:"
          psql -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} -c "SELECT * FROM healenium.run_counter ORDER BY run_id DESC LIMIT 5;"

      - name: Run tests
        run: |
          # Uncomment to run actual tests
          # mvn clean test
          echo "‚úÖ Tests would run here"

      - name: Dump database state
        run: |
          echo "üíæ Dumping PostgreSQL database to backup.sql..."
          pg_dump -h localhost -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} > db_dump/backup.sql

      - name: Stop Healenium services
        run: |
          cd infra
          docker-compose down
          cd ..

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results
          path: |
            target/surefire-reports/
            healing.json
            db_dump/backup.sql
          retention-days: 7
